# RAG系统测试指南

## 快速开始

### 1. 启动系统
```bash
# 启动ElasticSearch (如果未启动)
docker-compose up -d

# 启动API服务
python es_rag_api.py
```

### 2. 运行综合测试
```bash
# 安装依赖（如果需要）
pip install colorama

# 运行测试脚本
python comprehensive_test.py
```

## 测试方式

### 方式1：命令行测试

#### 健康检查
```bash
curl http://localhost:8000/api/health
```

#### 上传PDF
```bash
curl -X POST "http://localhost:8000/api/upload" \
  -F "file=@RoyalFortune_Product Brochure_EN.pdf"
```

#### 搜索文档
```bash
curl -X POST "http://localhost:8000/api/search" \
  -H "Content-Type: application/json" \
  -d "{\"query\":\"minimum premium\",\"size\":5}"
```

#### 问答
```bash
curl -X POST "http://localhost:8000/api/qa" \
  -H "Content-Type: application/json" \
  -d "{\"question\":\"What is the minimum premium?\"}"
```

### 方式2：Web界面测试

1. 打开浏览器访问：`http://localhost:8000/web_demo.html`
2. 功能测试：
   - 上传PDF文件
   - 搜索关键词
   - 提问并获取答案
   - 查看文档列表

### 方式3：API文档测试

1. 访问：`http://localhost:8000/docs`
2. 使用Swagger UI交互式测试每个API端点

## 测试用例

### 基础功能测试

| 测试项 | 输入 | 预期输出 |
|--------|------|----------|
| 最低保费查询 | "minimum premium" | USD 125,000 |
| 年龄范围查询 | "issue age" | Age 0-80 |
| 产品名查询 | "RoyalFortune" | 返回产品相关信息 |
| 中文查询 | "保费" | 返回保费相关内容 |

### 高级功能测试

1. **混合搜索测试**
   - 测试BM25关键词搜索
   - 测试向量相似度搜索
   - 验证混合评分机制

2. **置信度测试**
   - 验证高置信度答案（>70%）
   - 验证低置信度处理

3. **多文档测试**
   - 上传多个PDF
   - 跨文档搜索
   - 文档过滤功能

## Python测试示例

```python
import requests

# 简单测试函数
def quick_test():
    # 健康检查
    r = requests.get("http://localhost:8000/api/health")
    print(f"健康状态: {r.json()['status']}")
    
    # 搜索测试
    r = requests.post(
        "http://localhost:8000/api/search",
        json={"query": "minimum premium", "size": 3}
    )
    results = r.json()
    print(f"找到 {len(results)} 个结果")
    
    # 问答测试
    r = requests.post(
        "http://localhost:8000/api/qa",
        json={"question": "What is the minimum premium?"}
    )
    answer = r.json()
    print(f"答案: {answer['answer']}")
    print(f"置信度: {answer['confidence']:.2%}")

if __name__ == "__main__":
    quick_test()
```

## 常见问题

### 1. API无法启动
- 检查端口8000是否被占用
- 确认ElasticSearch已启动
- 验证OpenAI API密钥配置

### 2. 搜索无结果
- 确认PDF已成功上传
- 等待文档处理完成（约5-10秒）
- 检查ES索引状态

### 3. 向量编码失败
- 确认OpenAI版本：`pip show openai` (应为0.28.1)
- 检查API密钥是否有效
- 查看后台日志了解详细错误

### 4. 中文搜索问题
- 系统使用标准分词器
- 可考虑安装IK中文分词器以获得更好效果

## 性能基准

- PDF上传处理：~5秒/文档
- 搜索响应：<100ms
- 问答响应：1-3秒（含GPT调用）
- 并发支持：10+ QPS

## 监控和日志

查看API日志：
```bash
# 实时查看日志（如果在后台运行）
tail -f api.log

# 查看ES日志
docker logs es-rag-poc
```

## 进阶测试

### 压力测试
```bash
# 使用ab工具
ab -n 100 -c 10 -p search.json -T application/json \
   http://localhost:8000/api/search

# search.json内容
{"query": "premium", "size": 5}
```

### 批量上传测试
```python
import os
import requests
from concurrent.futures import ThreadPoolExecutor

def upload_file(filepath):
    with open(filepath, 'rb') as f:
        files = {'file': f}
        return requests.post(
            "http://localhost:8000/api/upload", 
            files=files
        )

# 并发上传多个文件
pdf_files = [f for f in os.listdir('.') if f.endswith('.pdf')]
with ThreadPoolExecutor(max_workers=3) as executor:
    results = executor.map(upload_file, pdf_files)
```